<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="AiModelMstrDAO">

	<!-- 모델 알고리즘 리스트  -->
	<select id="selectAlgList" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* AiModelMstrDAO.selectAlgList */
		 SELECT A.MODEL_ID
		      ,A.MODEL_NM
		      ,A.ALG_ID
		      ,A.AI_ID
		      ,A.MODEL_TYPE
		      <!-- ,dbo.F_CODE_NM('MODEL_TYPE', A.MODEL_TYPE) as MODEL_TYPE_NM -->
			  ,A.MODEL_STATUS
		      <!-- ,dbo.F_CODE_NM('AI_STATUS', A.MODEL_STATUS) as MODEL_STATUS_NM -->
		      ,A.DATASET_ID
		      ,A.DEL_YN
		      ,A.REG_USER_NO
		      ,A.REG_DT
		      ,A.UPD_USER_NO
		      ,A.UPD_DT
		  FROM WP2_AI_MODEL_MSTR A 
	 	  WHERE A.AI_ID = #AI_ID#
	 	   AND A.DEL_YN = 'N' 
	</select>
	
	<!-- 모델학습  -->
	<select id="selectList" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* AiModelMstrDAO.selectList */
		 SELECT A.MODEL_ID
		      ,A.MODEL_NM
		      ,A.ALG_ID
		      ,A.AI_ID
		      ,C.ALG_NM
			  ,D.FLD_NM
		      ,A.MODEL_TYPE
		      ,dbo.F_CODE_NM('MODEL_TYPE', A.MODEL_TYPE) as MODEL_TYPE_NM
			  ,A.MODEL_STATUS
		      ,dbo.F_CODE_NM('AI_STATUS', A.MODEL_STATUS) as MODEL_STATUS_NM
		      ,E.SEG_NM
			  ,A.MODEL_PROGRESS
		      ,A.MODEL_RUN_TYPE
		      ,A.MODEL_EVAL_TYPE
		      ,A.MODEL_EVAL_RESULT
		      ,A.DATASET_ID
		      ,A.DEL_YN
		      ,A.MODEL_FEATURE_TYPE
		      ,A.MODEL_PART_OPTION
		      ,A.MODEL_ARG_PARAM
		      ,A.MODEL_OPTIMIZER_YN
		      ,A.REG_USER_NO
		      ,A.REG_DT
		      ,A.UPD_USER_NO
		      ,A.UPD_DT
		  FROM WP2_AI_MODEL_MSTR A JOIN WP2_AI_MSTR B ON A.AI_ID = B.AI_ID
		                         JOIN WP2_AI_ALG_MSTR C ON A.ALG_ID = C.ALG_ID
								 JOIN WP2_TYPE_AI_MSTR D ON B.FLD_ID = D.FLD_ID 
						         JOIN WP2_SEG_MSTR E ON B.SEG_ID = E.SEG_ID
	 	  WHERE A.AI_ID = #AI_ID#
	 	   AND A.DEL_YN = 'N' 
	</select>
	
	<insert id="insert"  parameterClass="java.util.Map">
		/* AiModelMstrDAO.insert */
		INSERT 
		  INTO WP2_AI_MODEL_MSTR (
		       MODEL_NM
		      ,ALG_ID
		      ,AI_ID
		      ,MODEL_TYPE
		      ,MODEL_STATUS
		      <!-- ,MODEL_PROGRESS
		      ,MODEL_RUN_TYPE
		      ,MODEL_EVAL_TYPE
		      ,MODEL_EVAL_RESULT -->
		      ,DATASET_ID
		      ,DEL_YN
		      <!-- ,MODEL_FEATURE_TYPE
		      ,MODEL_PART_OPTION
		      ,MODEL_ARG_PARAM
		      ,MODEL_OPTIMIZER_YN -->
		      ,REG_USER_NO
		      ,REG_DT
		     ) 
			SELECT
			   dbo.F_CODE_NM('MODEL_TYPE', A.MODEL_TYPE) + '-' + ALG_NM + '-' + convert(nvarchar, #ORDINAL#) 
			 , #ALG_ID#
			 , #AI_ID#
			 , A.MODEL_TYPE
			 , #MODEL_STATUS#
			 , #DATASET_ID#
			 , #DEL_YN#
			 , #REG_USER_NO#
			 , NOW()
			FROM WP2_AI_ALG_MSTR A
			WHERE ALG_ID = #ALG_ID# 
		<selectKey keyProperty="MODEL_ID" resultClass="Integer">
			SELECT ident_current('WP2_AI_MODEL_MSTR')
		</selectKey>
	</insert>
	
	<!-- 수정을 위한 기존 모델 삭제  -->
	<update id="deleteByAiId" parameterClass="java.util.HashMap">
	  /* AiModelMstrDAO.deleteByAiId */
		DELETE
		  FROM WP2_AI_MODEL_MSTR
	     WHERE AI_ID = #AI_ID#
	</update>
	
	<!-- 모델확정 -->
	<update id="update" parameterClass="java.util.HashMap">
	  /* AiModelMstrDAO.update */
		UPDATE WP2_AI_MODEL_MSTR
		   SET USE_YN = #USE_YN#    
		     , UPD_USER_NO        = #UPD_USER_NO#     
		     , UPD_DT             = NOW() 
	     WHERE MODEL_ID = #MODEL_ID#
	</update>
	
	<!-- 모델삭제 -->
	<update id="updateDelYnByAiId" parameterClass="java.util.HashMap">
	  /* AiModelMstrDAO.deleteByAiId */
		UPDATE WP2_AI_MODEL_MSTR
		   SET DEL_YN = 'Y'      
		     , UPD_USER_NO        = #UPD_USER_NO#     
		     , UPD_DT             = NOW() 
	     WHERE AI_ID = #AI_ID#
	</update>
	
	<select id="select" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* AiModelMstrDAO.select */
		 SELECT A.MODEL_ID
		      ,A.MODEL_NM
		      ,A.ALG_ID
		      ,A.AI_ID
		      ,A.MODEL_TYPE
		      ,A.MODEL_STATUS
		      ,A.DATASET_ID
		      ,A.DEL_YN
		      ,A.REG_USER_NO
		      ,A.REG_DT
		      ,A.UPD_USER_NO
		      ,A.UPD_DT
		  FROM WP2_AI_MODEL_MSTR A
	 	  WHERE A.MODEL_ID = #MODEL_ID#
	</select>
	
	<select id="selectCountByModelStatus50" parameterClass="java.util.Map" resultClass="int">
		/* AiModelMstrDAO.selectCountByModelStatus50 */
		SELECT COUNT(*)
  		FROM WP2_AI_MODEL_MSTR A 
  		WHERE 1=1
		  AND A.MODEL_STATUS = '50'
		  AND A.AI_ID = #AI_ID#
	</select>
	
	<select id="selectListForAiModelTree" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* AiModelMstrDAO.selectListForAiModelTree */
		SELECT
			id
			, text
			, parent
			, type
			, ord1
			, ord2
		FROM (
			 SELECT
				  'T' + CAST(FLD_ID AS CHAR(50)) AS id
				, FLD_NM AS text
			    , CASE WHEN FLD_PARENT_ID =  0 THEN <![CDATA['##']]> ELSE convert(varchar(255), FLD_PARENT_ID) END AS parent
				, 'typeItem' AS type
				, 1 AS ord1
				, FLD_ORDINAL as ord2
			FROM WP2_TYPE_AI_MSTR A
			UNION
			SELECT
				 'A' + CAST(AI_ID AS CHAR(50)) AS id
				, AI_NM AS text
				, CASE WHEN FLD_ID =  0 THEN <![CDATA['##']]> ELSE 'T' + CONVERT(nvarchar(20), FLD_ID) END AS parent
				, 'typeAi' AS type
				, 2 AS ord1
				, ORDINAL  as ord2
			FROM WP2_AI_MSTR A
			WHERE 1=1
			  and DEL_YN = 'N'
			  and (SELECT COUNT(1) FROM WP2_AI_MODEL_MSTR B WHERE B.DEL_YN = 'N' AND B.USE_YN = 'Y' AND B.AI_ID = A.AI_ID) > 0
			UNION
			SELECT
				  CAST(MODEL_ID AS CHAR(50)) AS id
				, MODEL_NM AS text
				, 'A' + CONVERT(nvarchar(20), AI_ID) as parent
				, 'item' AS type
				, 3 AS ord1
				, ROW_NUMBER() OVER (ORDER BY MODEL_ID)  as ord2
			FROM WP2_AI_MODEL_MSTR
			WHERE 1=1
			  and DEL_YN = 'N'
			  AND USE_YN = 'Y'
		) AS C
		ORDER BY ord1, ord2
	</select>
	
</sqlMap>