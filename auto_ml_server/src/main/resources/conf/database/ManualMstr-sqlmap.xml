<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ManualMstrDAO">

	<select id="selectListForManualTree" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* ManualMstrDAO.selectListForManualTree */
		SELECT
			id
			, text
			, children
			, type
			, ord1
			, ord2
			, SEG_ID
			, MANUAL_ID
			, MANUAL_NM
			, FLD_ID
			, RTN_CNT
			, DESIGN_KEY_VALUE
			, MANUAL_DESC
			, DEL_YN
			, ORDINAL
			, REG_USER_NO
			, REG_DT
			, UPD_USER_NO
			, UPD_DT
			, FLD_NM
			, SEG_NM
			, MANUAL_XML
			, MANUAL_SQL
		FROM (
			SELECT
				'T' + CAST(FLD_ID AS CHAR(50)) AS id
				, FLD_NM AS text
				, CONVERT(
					BIT
					, (SELECT COUNT(*) FROM WP2_TYPE_MANUAL_MSTR WHERE FLD_PARENT_ID = A.FLD_ID)
						+ (SELECT COUNT(*) FROM WP2_MANUAL_MSTR WHERE FLD_ID = A.FLD_ID AND DEL_YN = 'N')
					) AS children
				, 'typeManual' AS type
				, 1 AS ord1
				, FLD_ORDINAL as ord2
				,NULL AS SEG_ID
				,NULL AS MANUAL_ID
				,NULL AS MANUAL_NM
				,NULL AS FLD_ID
				,NULL AS RTN_CNT
				,NULL AS DESIGN_KEY_VALUE
				,NULL AS MANUAL_DESC
				,NULL AS DEL_YN
				,NULL AS ORDINAL
				,NULL AS REG_USER_NO
				,NULL AS REG_DT
				,NULL AS UPD_USER_NO
				,NULL AS UPD_DT
				,NULL AS FLD_NM
				,NULL AS SEG_NM
				,NULL AS MANUAL_XML
				,NULL AS MANUAL_SQL
			FROM WP2_TYPE_MANUAL_MSTR A
			WHERE FLD_PARENT_ID = #FLD_PARENT_ID#
			UNION ALL
			SELECT
				CAST(B.MANUAL_ID AS CHAR(50)) AS id
				, B.MANUAL_NM AS text
				, CONVERT(BIT, 0) AS children
				, 'manual' AS type
				, 2 AS ord1
				, B.ORDINAL as ord2
				,B.SEG_ID
				,B.MANUAL_ID
				,B.MANUAL_NM
				,B.FLD_ID
				,B.RTN_CNT
				,B.DESIGN_KEY_VALUE
				,B.MANUAL_DESC
				,B.DEL_YN
				,B.ORDINAL
				,B.REG_USER_NO
				,B.REG_DT
				,B.UPD_USER_NO
				,B.UPD_DT
				,C.FLD_NM
				,D.SEG_NM
				,dbo.F_DECRYPT(B.MANUAL_XML) AS MANUAL_XML
				,dbo.F_DECRYPT(B.MANUAL_SQL) AS MANUAL_SQL
			FROM WP2_MANUAL_MSTR B
	  			JOIN WP2_TYPE_MANUAL_MSTR C ON B.FLD_ID = C.FLD_ID
	  			JOIN WP2_SEG_MSTR D ON B.SEG_ID = D.SEG_ID
			WHERE B.FLD_ID = #FLD_PARENT_ID#
				AND B.DEL_YN = 'N'
		) AS C
		ORDER BY ord1, ord2		
	</select>

	<select id="selectListForManualGrid" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* ManualMstrDAO.selectListForManualGrid */
		SELECT
			A.SEG_ID
			,A.MANUAL_ID
			,A.MANUAL_NM
			,A.FLD_ID
			,A.RTN_CNT
			,A.DESIGN_KEY_VALUE
			,A.MANUAL_DESC
			,A.DEL_YN
			,A.ORDINAL
			,A.REG_USER_NO
			,A.REG_DT
			,A.UPD_USER_NO
			,A.UPD_DT
			,B.FLD_NM
			,C.SEG_NM
			,dbo.F_DECRYPT(A.MANUAL_XML) AS MANUAL_XML
			,dbo.F_DECRYPT(A.MANUAL_SQL) AS MANUAL_SQL
  		FROM WP2_MANUAL_MSTR A
  			JOIN WP2_TYPE_MANUAL_MSTR B ON A.FLD_ID = B.FLD_ID
  			JOIN WP2_SEG_MSTR C ON A.SEG_ID = C.SEG_ID
  		WHERE 1=1
			AND A.FLD_ID = #FLD_ID#
			AND A.DEL_YN = 'N' 
		ORDER BY A.ORDINAL 
	</select>
	
	<!-- 수정 -->
	<update id="update" parameterClass="java.util.HashMap">
		UPDATE
			WP2_MANUAL_MSTR
		SET
			SEG_ID = #SEG_ID#
			,MANUAL_NM = #MANUAL_NM#
			,FLD_ID = #FLD_ID#
			,RTN_CNT = #RTN_CNT#
			,DESIGN_KEY_VALUE = #DESIGN_KEY_VALUE#
			,MANUAL_XML = dbo.F_ENCRYPT(#MANUAL_XML#)
			,MANUAL_SQL = dbo.F_ENCRYPT(#MANUAL_SQL#)
			,MANUAL_DESC = #MANUAL_DESC#
			,ORDINAL = #ORDINAL#
			,UPD_USER_NO = #USER_NO#
			,UPD_DT = NOW()
		WHERE
			MANUAL_ID = #MANUAL_ID#
	</update>
	
	<!-- 삭제 -->
	<update id="delete" parameterClass="java.util.HashMap">
		UPDATE
			WP2_MANUAL_MSTR
		SET
			DEL_YN = 'Y'
			,UPD_USER_NO = #USER_NO#
			,UPD_DT = NOW()
		WHERE
			MANUAL_ID = #MANUAL_ID#
	</update>

	<insert id="insert" parameterClass="java.util.Map">
		INSERT INTO WP2_MANUAL_MSTR (
			SEG_ID
			,MANUAL_NM
			,FLD_ID
			,RTN_CNT
			,DESIGN_KEY_VALUE
			,MANUAL_XML
			,MANUAL_SQL
			,MANUAL_DESC
			,DEL_YN
			,ORDINAL
			,REG_USER_NO
			,REG_DT
		) VALUES (
			#SEG_ID#
			,#MANUAL_NM#
			,#FLD_ID#
			,#RTN_CNT#
			,#DESIGN_KEY_VALUE#
			,dbo.F_ENCRYPT(#MANUAL_XML#)
			,dbo.F_ENCRYPT(#MANUAL_SQL#)
			,#MANUAL_DESC#
			,#DEL_YN#
			,#ORDINAL#
			,#USER_NO#
			,NOW()
		)
		<selectKey keyProperty="MANUAL_ID" resultClass="Integer">
			SELECT ident_current('WP2_MANUAL_MSTR')
		</selectKey>
	</insert>

 	<select id="selectListByManualNm" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* ManualMstrDAO.selectListByManualNm */
		SELECT
			A.SEG_ID
			,A.MANUAL_ID
			,A.MANUAL_NM
			,A.FLD_ID
			,A.RTN_CNT
			,A.DESIGN_KEY_VALUE
			,A.MANUAL_DESC
			,A.DEL_YN
			,A.ORDINAL
			,A.REG_USER_NO
			,A.REG_DT
			,A.UPD_USER_NO
			,A.UPD_DT
			,B.FLD_NM
			,C.SEG_NM
  		FROM WP2_MANUAL_MSTR A
  			JOIN WP2_TYPE_MANUAL_MSTR B ON A.FLD_ID = B.FLD_ID
  			JOIN WP2_SEG_MSTR C ON A.SEG_ID = C.SEG_ID
  		WHERE 1=1
		  AND A.MANUAL_NM = #MANUAL_NM#
		  <isEqual property="case" compareValue="update">
			  AND A.MANUAL_ID <![CDATA[<>]]> #MANUAL_ID#
		  </isEqual>
		  <isEqual property="case" compareValue="insert">
		  </isEqual>
		  AND A.DEL_YN = 'N'
	</select>
	
	<select id="selectListForManualCheckableTree" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* ManualMstrDAO.selectListForManualCheckableTree */
		SELECT
			id
			, text
			, children
			, type
			, ord1
			, ord2
			, SEG_ID
			, MANUAL_ID
			, MANUAL_NM
			, FLD_ID
			, RTN_CNT
			, DESIGN_KEY_VALUE
			, MANUAL_DESC
			, DEL_YN
			, ORDINAL
			, REG_USER_NO
			, REG_DT
			, UPD_USER_NO
			, UPD_DT
			, FLD_NM
			, SEG_NM
			, MANUAL_XML
			, MANUAL_SQL
			, '30' AS RECO_TYPE
			, '편성기반' AS RECO_TYPE_NM
			, MANUAL_ID AS RECO_ID
			, MANUAL_NM AS RECO_NM
			, '' AS ITEM_ID
			, 1 AS ITEM_ORDINAL
		FROM (
			SELECT
				'T' + CAST(FLD_ID AS CHAR(50)) AS id
				, FLD_NM AS text
				, CONVERT(
					BIT
					, (SELECT COUNT(*) FROM WP2_TYPE_MANUAL_MSTR WHERE FLD_PARENT_ID = A.FLD_ID)
						+ (SELECT COUNT(*) FROM WP2_MANUAL_MSTR WHERE FLD_ID = A.FLD_ID AND DEL_YN = 'N')
					) AS children
				, 'typeManual' AS type
				, 1 AS ord1
				, FLD_ORDINAL as ord2
				,NULL AS SEG_ID
				,NULL AS MANUAL_ID
				,NULL AS MANUAL_NM
				,NULL AS FLD_ID
				,NULL AS RTN_CNT
				,NULL AS DESIGN_KEY_VALUE
				,NULL AS MANUAL_DESC
				,NULL AS DEL_YN
				,NULL AS ORDINAL
				,NULL AS REG_USER_NO
				,NULL AS REG_DT
				,NULL AS UPD_USER_NO
				,NULL AS UPD_DT
				,NULL AS FLD_NM
				,NULL AS SEG_NM
				,NULL AS MANUAL_XML
				,NULL AS MANUAL_SQL
			FROM WP2_TYPE_MANUAL_MSTR A
			WHERE FLD_PARENT_ID = #FLD_PARENT_ID#
			UNION ALL
			SELECT
				CAST(B.MANUAL_ID AS CHAR(50)) AS id
				, B.MANUAL_NM AS text
				, CONVERT(BIT, 0) AS children
				, 'manual' AS type
				, 2 AS ord1
				, B.ORDINAL as ord2
				,B.SEG_ID
				,B.MANUAL_ID
				,B.MANUAL_NM
				,B.FLD_ID
				,B.RTN_CNT
				,B.DESIGN_KEY_VALUE
				,B.MANUAL_DESC
				,B.DEL_YN
				,B.ORDINAL
				,B.REG_USER_NO
				,B.REG_DT
				,B.UPD_USER_NO
				,B.UPD_DT
				,C.FLD_NM
				,D.SEG_NM
				,dbo.F_DECRYPT(B.MANUAL_XML) AS MANUAL_XML
				,dbo.F_DECRYPT(B.MANUAL_SQL) AS MANUAL_SQL
			FROM WP2_MANUAL_MSTR B
	  			JOIN WP2_TYPE_MANUAL_MSTR C ON B.FLD_ID = C.FLD_ID
	  			JOIN WP2_SEG_MSTR D ON B.SEG_ID = D.SEG_ID
			WHERE B.FLD_ID = #FLD_PARENT_ID#
				AND B.DEL_YN = 'N'
				<isNotEmpty prepend="AND" property="exceptItemId">
					<iterate prepend="B.MANUAL_ID NOT IN " property="exceptItemId" open="(" close=")" conjunction=",">
						$exceptItemId[]$
					</iterate>
				</isNotEmpty>
		) AS C
		ORDER BY ord1, ord2		
	</select>

</sqlMap>