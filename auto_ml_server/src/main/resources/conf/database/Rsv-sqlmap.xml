<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="RsvDAO">
 	<sql id="pagestart">
 		<![CDATA[
 	      		SELECT A.*
			FROM  ( 
					 SELECT @rownum := @rownum + 1 AS RK, A.*                
		  			   FROM (
		]]>
 	</sql>
 	
 	<sql id="pageend">
 		<![CDATA[
 			          			 ) A ,(SELECT @rownum := 0) XX  
		          	) A		  
		  WHERE CEIL(RK/#PAGESIZE#)  = IFNULL(#pageNo#,1)
		]]>
 	</sql>
	<!-- 내일 이후 예약 현황 조회 -->
	<select id="selectTmrRsvStatus" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* RsvDAO.selectTmrRsvStatus */
		    SELECT
				    IFNULL(SUM(CASE WHEN GBN = 'REQ' AND R.RSV_ST_CD = 'R' THEN 1 
				           ELSE 0 END),0) AS RSV_REQ_R /* 변경접수(요청) */
				  , IFNULL(SUM(CASE WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'S' THEN 1 
				           ELSE 0 END),0) AS RSV_CONFIRM_S /* 예약확인*/
				  , IFNULL(SUM(CASE WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'U' THEN 1 
				           ELSE 0 END),0) AS RSV_CONFIRM_U /* 예약변경완료*/
				  , IFNULL(SUM(CASE WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'C' THEN 1 
				           ELSE 0 END),0) AS RSV_CONFIRM_C /* 예약취소완료 */
				  , IFNULL(SUM(CASE WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'I' THEN 1 
				           ELSE 0 END),0) AS RSV_CONFIRM_I /* 병원이벤트정보 */
				  , IFNULL(SUM(CASE WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'E' THEN 1 
				           ELSE 0 END),0) AS RSV_CONFIRM_E /* 에러오입력 */
				FROM 
				(
				  SELECT 
				    'REQ' AS GBN
				    , R.RSV_SNO
				    , R.HSPT_ID
				    , R.RSV_DAY
				    , R.RSV_ST_CD
				  FROM TB_HSPT_RSV_REQ R
				  WHERE DEL_YN = 'N'
				  AND  EXISTS
				       (
					        SELECT 1 FROM TB_USER U 
					        WHERE U.HSPT_ID = R.HSPT_ID
					        AND U.DEL_YN = 'N'
					        AND U.USER_ID = #userId#
				        )
				<isNotEmpty property="RSV_DAY">
				  /* AND R.RSV_DAY = date_format(DATE_ADD(NOW(), INTERVAL 1 DAY), '%Y%m%d') -- 오늘 기준 다음날 */
				     AND R.RSV_DAY >= REPLACE(#RSV_DAY#,'-','') /*예약일*/
				</isNotEmpty>
				  UNION ALL 
				  SELECT
				    'CONFIRM'
				    , R.RSV_SNO
				    , R.HSPT_ID
				    , R.RSV_DAY
				    , R.RSV_ST_CD
				  FROM TB_HSPT_RSV_CONFIRM R
				  WHERE DEL_YN = 'N'
					  AND  EXISTS
					     (
						      SELECT 1 FROM TB_USER U 
						      WHERE U.HSPT_ID = R.HSPT_ID
						      AND U.DEL_YN = 'N'
						      AND U.USER_ID = #userId#
					      )
				<isNotEmpty property="RSV_DAY">
				     AND R.RSV_DAY >= REPLACE(#RSV_DAY#,'-','') /*예약일*/
				</isNotEmpty>
				) R
	</select>

 	<!-- 내일 이후 예약변경 요청 조회 -->
	<select id="selectTmrRsvChgReq" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* RsvDAO.selectRsvChgReq */
		<dynamic>
			<include refid="pagestart"/>
		</dynamic>
      	SELECT 
		  R.HSPT_ID
		, R.HSPT_TEL_NO
		, R.RSV_SNO
        , R.CUST_NM
        , F_DECRYPT(R.CUST_TEL_NO) AS CUST_TEL_NO
        , F_GET_DATE(1, R.RSV_DT) AS RSV_DT
        , R.RSV_ST_CD
		  FROM TB_HSPT_RSV_REQ R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
      AND R.RSV_ST_CD IN ('R')
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY >= REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
		ORDER BY R.RSV_DT ASC , R.CUST_NM
		<dynamic>
			<include refid="pageend"/>
		</dynamic>
	</select>
	
	<!-- 내일 이후 예약변경 요청 조회 갯수 -->
	<select id="selectTmrRsvChgReqCount" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* RsvDAO.selectTmrRsvChgReqCount */
      	SELECT 
           COUNT(*) CNT
		  FROM TB_HSPT_RSV_REQ R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
      AND R.RSV_ST_CD IN ('R')
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY >= REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
	</select>

	<!-- 예약변경 요청 조회 -->
	<select id="selectRsvChgReq" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* RsvDAO.selectRsvChgReq */
		<dynamic>
			<include refid="pagestart"/>
		</dynamic>
      	SELECT 
		  R.HSPT_ID
		, R.HSPT_TEL_NO  
		, R.RSV_SNO
        , R.CUST_NM
        , F_DECRYPT(R.CUST_TEL_NO) AS CUST_TEL_NO
        , F_GET_DATE(1, R.RSV_DT) AS RSV_DT
        , R.RSV_ST_CD
		  FROM TB_HSPT_RSV_REQ R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
      AND R.RSV_ST_CD IN ('R')
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
		ORDER BY R.RSV_DT ASC , R.CUST_NM
		<dynamic>
			<include refid="pageend"/>
		</dynamic>
	</select>
	
	<!-- 예약변경 요청 조회 갯수 -->
	<select id="selectRsvChgReqCount" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* RsvDAO.selectRsvChgReqCount */
      	SELECT 
           COUNT(*) CNT
		  FROM TB_HSPT_RSV_REQ R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
      AND R.RSV_ST_CD IN ('R')
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
	</select>



	<!-- 예약 조회 -->
	<select id="selectRsvList" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* RsvDAO.selectRsvList */

		SELECT
		  R.HSPT_ID
		  , R.HSPT_TEL_NO
		  , R.RSV_SNO
      	  , F_GET_DATE(1, R.RSV_DT) AS RSV_DT
      	  , R.CUST_NM
		  , CASE WHEN GBN = 'REQ' AND R.RSV_ST_CD = 'R' THEN '예약변경접수' 
             WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'S' THEN '예약확인' 
             WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'U' THEN '예약변경완료' 
             WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'C' THEN '예약취소완료' 
             WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'I' THEN '병원이벤트정보' 
             WHEN GBN = 'CONFIRM' AND R.RSV_ST_CD = 'E' THEN '에러오입력' 
        	END AS RSV_ST_CD
	      , F_DECRYPT(CUST_TEL_NO) AS CUST_TEL_NO
		FROM 
		(
		  SELECT 
		    'REQ' AS GBN
		    , R.RSV_SNO
       		, R.RSV_ST_CD
		    , R.HSPT_ID
		    , R.HSPT_TEL_NO
	        , R.CUST_NM
	        , R.CUST_TEL_NO
	        , R.RSV_DT
		  FROM TB_HSPT_RSV_REQ R
		  WHERE DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		  /* AND R.RSV_DAY = date_format(DATE_ADD(NOW(), INTERVAL 1 DAY), '%Y%m%d') -- 오늘 기준 다음날 */
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>

		  UNION ALL 
		  SELECT
		    'CONFIRM'
		    , R.RSV_SNO
        	, R.RSV_ST_CD
		    , R.HSPT_ID
		    , R.HSPT_TEL_NO
	        , R.CUST_NM
	        , R.CUST_TEL_NO
	        , R.RSV_DT
		  FROM TB_HSPT_RSV_CONFIRM R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
		) R
    WHERE RSV_ST_CD IN ('R','S','U','C')
    ORDER BY  RSV_DT ASC , CUST_NM ASC, RSV_ST_CD ASC

	</select>

	<!-- 예약 조회 갯수 -->
	<select id="selectRsvListCount" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* RsvDAO.selectRsvListCount */
		SELECT
		  COUNT(*) CNT
		FROM 
		(
		  SELECT 
		    'REQ' AS GBN
		    , R.RSV_SNO
       		, R.RSV_ST_CD
		    , R.HSPT_ID
		    , R.HSPT_TEL_NO
	        , R.CUST_NM
	        , R.CUST_TEL_NO
	        , R.RSV_DT
		  FROM TB_HSPT_RSV_REQ R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
		  UNION ALL 
		  SELECT
		    'CONFIRM'
		    , R.RSV_SNO
        	, R.RSV_ST_CD
		    , R.HSPT_ID
		    , R.HSPT_TEL_NO
	        , R.CUST_NM
	        , R.CUST_TEL_NO
	        , R.RSV_DT
		  FROM TB_HSPT_RSV_CONFIRM R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
		) R
    ORDER BY RSV_DT ASC , CUST_NM ASC
	</select>
    
	<!-- 예약확인 조회 -->
	<select id="selectRsvSuccess" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* RsvDAO.selectRsvSuccess */
		<dynamic>
			<include refid="pagestart"/>
		</dynamic>  
       	SELECT 
          	  R.HSPT_ID
          	  , R.HSPT_TEL_NO
              , R.RSV_SNO
              , R.CUST_NM
              , F_DECRYPT(CUST_TEL_NO) AS CUST_TEL_NO
	          , F_GET_DATE(1, R.RSV_DT) AS RSV_DT
	          , R.RSV_ST_CD
	          , F_GET_DATE(1, R.RSV_CONFIRM_DTTM) AS RSV_CONFIRM_DTTM
      		  FROM TB_HSPT_RSV_CONFIRM R
      		  WHERE DEL_YN = 'N'
		      AND  EXISTS
			       (
				        SELECT 1 FROM TB_USER U 
				        WHERE U.HSPT_ID = R.HSPT_ID
				        AND U.DEL_YN = 'N'
				        AND U.USER_ID = #userId#
			        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
            AND R.RSV_ST_CD IN ('S')
            ORDER BY R.RSV_DT ASC , R.CUST_NM
		  
		<dynamic>
			<include refid="pageend"/>
		</dynamic>
	</select>
	
	<!-- 예약확인 조회 갯수 -->
	<select id="selectRsvSuccessCount" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* RsvDAO.selectRsvSuccessCount */
      	SELECT 
		  COUNT(*) CNT
		  FROM TB_HSPT_RSV_CONFIRM R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
          AND R.RSV_ST_CD IN ('S')
	</select>
	
	<!-- 예약변경완료 조회 -->
	<select id="selectRsvUpdConfirm" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* RsvDAO.selectRsvUpdConfirm */
		<dynamic>
			<include refid="pagestart"/>
		</dynamic>
      	SELECT 
		  R.HSPT_ID
		, R.HSPT_TEL_NO  
		, R.RSV_SNO
        , R.CUST_NM
        , F_DECRYPT(R.CUST_TEL_NO) AS CUST_TEL_NO
        , F_GET_DATE(1, R.RSV_DT) AS RSV_DT
        , R.RSV_ST_CD
        , F_GET_DATE(1, R.RSV_CONFIRM_DTTM) AS RSV_CONFIRM_DTTM
		  FROM TB_HSPT_RSV_CONFIRM R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
      AND R.RSV_ST_CD IN ('U')
      ORDER BY R.RSV_DT ASC , R.CUST_NM
		<dynamic>
			<include refid="pageend"/>
		</dynamic>
	</select>
	
	<!-- 예약변경완료 조회 갯수 -->
	<select id="selectRsvUpdConfirmCount" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* RsvDAO.selectRsvUpdConfirmCount */
      	SELECT 
		  COUNT(*) CNT
		  FROM TB_HSPT_RSV_CONFIRM R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
          AND R.RSV_ST_CD IN ('U')
	</select>

	<!-- 예약취소완료 조회 -->
	<select id="selectRsvCnlConfirm" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* RsvDAO.selectRsvCnlConfirm */
		<dynamic>
			<include refid="pagestart"/>
		</dynamic>
      	SELECT 
		  R.HSPT_ID
		, R.HSPT_TEL_NO  
		, R.RSV_SNO
        , R.CUST_NM
        , F_DECRYPT(R.CUST_TEL_NO) AS CUST_TEL_NO
        , F_GET_DATE(1, R.RSV_DT) AS RSV_DT
        , R.RSV_ST_CD
        , F_GET_DATE(1, R.RSV_CONFIRM_DTTM) AS RSV_CONFIRM_DTTM
		  FROM TB_HSPT_RSV_CONFIRM R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
          AND R.RSV_ST_CD IN ('C')
          ORDER BY R.RSV_DT ASC , R.CUST_NM
		<dynamic>
			<include refid="pageend"/>
		</dynamic>
	</select>
	
	<!-- 예약취소완료 조회 -->
	<select id="selectRsvCnlConfirmCount" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* RsvDAO.selectRsvCnlConfirmCount */
      	SELECT 
		  COUNT(*) CNT
		  FROM TB_HSPT_RSV_CONFIRM R
		  WHERE R.DEL_YN = 'N'
		  AND  EXISTS
		       (
			        SELECT 1 FROM TB_USER U 
			        WHERE U.HSPT_ID = R.HSPT_ID
			        AND U.DEL_YN = 'N'
			        AND U.USER_ID = #userId#
		        )
		<isNotEmpty property="RSV_DAY">
		     AND R.RSV_DAY = REPLACE(#RSV_DAY#,'-','') /*예약일*/
		</isNotEmpty>
          AND R.RSV_ST_CD IN ('C')
	</select>
	
	

	<!-- 병원 확정 요청에서 확정으로 데이터 이관 1단계(요청 에서 확정으로 입력)  -->
	<insert id="saveHsptConfirmStep1" parameterClass="java.util.Map">
		/* RsvDAO.saveHsptConfirmStep1 */
		<![CDATA[
      	  INSERT INTO TB_HSPT_RSV_CONFIRM
      	  (
			 RSV_SNO
			, RSV_WEB_ACC_KEY
			, RSV_URL
			, HSPT_ID
			, HSPT_NM
			, HSPT_TEL_NO
			, CUST_NO
			, CUST_NM
			, CUST_TEL_NO
			, RSV_DAY
			, RSV_DT
			, RSV_ST_CD
			, KT_TO_BELL_PUSH_SNO
			, RSV_DT_SAVE_YN
			, DEL_YN
			, REG_DAY
            , REG_DT
			, REGI_ID
			, REGI_DTTM
			, UPDT_ID
			, UPDT_DTTM
			, RSV_CONFIRM_ID
			, RSV_CONFIRM_DTTM
      	  )
		SELECT
			 RSV_SNO
			, RSV_WEB_ACC_KEY
			, RSV_URL
			, HSPT_ID
			, HSPT_NM
			, HSPT_TEL_NO
			, CUST_NO
			, CUST_NM
			, CUST_TEL_NO
			, RSV_DAY
			, RSV_DT
			, #RSV_ST_CD# RSV_ST_CD
			, KT_TO_BELL_PUSH_SNO
			, RSV_DT_SAVE_YN
			, DEL_YN
			, REG_DAY
            , REG_DT
			, REGI_ID
			, REGI_DTTM
			, UPDT_ID
			, UPDT_DTTM
			, #userId# RSV_CONFIRM_ID
			, NOW() RSV_CONFIRM_DTTM
		FROM TB_HSPT_RSV_REQ
		WHERE RSV_SNO = #RSV_SNO#
      	  AND DEL_YN = 'N'

		]]>
	</insert>
	
	<!-- 병원 확정 요청에서 확정으로 데이터 이관 2단계(요청 삭제)  -->
	<delete id="saveHsptConfirmStep2" parameterClass="java.util.Map">
		/* RsvDAO.saveHsptConfirmStep2 */
		<![CDATA[
      	  DELETE FROM TB_HSPT_RSV_REQ
		  WHERE RSV_SNO = #RSV_SNO#
      	  AND DEL_YN = 'N'
      	 ]]>
	</delete>
	
	<!-- 고객 한테 전송할 문자 메시지를 조회 한다  -->
	<select id="userSendMessage" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* RsvDAO.userSendMessage */
		SELECT F_MNG_USER_SEND_MESSAGE(#RSV_ST_CD#,#RSV_SNO#) userSendMessage
	</select>
</sqlMap>