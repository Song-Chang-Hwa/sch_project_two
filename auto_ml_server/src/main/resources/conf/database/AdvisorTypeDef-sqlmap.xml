<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="AdvisorTypeDefDAO">
 	
 	
 	<select id="selectList" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* AdvisorTypeDefDAO.selectList */
		WITH CTE AS 
		 (
		 SELECT FLD_ID
			  ,FLD_NM
			  ,FLD_LVL
			  ,FLD_PARENT_ID
			  ,FLD_ORDINAL
			  ,FLD_BIZ_KEY
			  ,FLD_DESC
			  , convert(varchar(255), FLD_ID) SORT 
			  <!--  , convert(varchar(255), FLD_NM) depth_fullname -->
		  FROM $TABLE_NAME$
		  where FLD_PARENT_ID = 0 
		  UNION ALL 
		SELECT B.FLD_ID
			  ,B.FLD_NM
			  ,B.FLD_LVL
			  ,B.FLD_PARENT_ID
			  ,B.FLD_ORDINAL
			  ,B.FLD_BIZ_KEY
			  ,B.FLD_DESC
			  , convert(varchar(255), convert(nvarchar,C.sort) + ' > ' + convert(varchar(255), B.FLD_ID)) SORT 
			  <!--  , convert(varchar(255), convert(nvarchar,C.depth_fullname) + ' > ' + convert(varchar(255), B.FLD_NM)) depth_fullname  -->
		 FROM $TABLE_NAME$ B, CTE C 
		 WHERE B.FLD_PARENT_ID = C.FLD_ID 
		 ) SELECT FLD_ID
			  ,FLD_NM
			  ,FLD_LVL
			  ,FLD_PARENT_ID
			  ,FLD_ORDINAL
			  ,FLD_BIZ_KEY
			  ,FLD_DESC
			  ,SORT
			  <!--   , depth_fullname  -->
		    FROM CTE order by SORT
	</select>
	
	<select id="selectTreeList" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* AdvisorTypeDefDAO.selectTreeList */
		SELECT FLD_ID
			,FLD_NM
			,FLD_LVL
			,FLD_PARENT_ID
			,(SELECT FLD_NM FROM $TABLE_NAME$ X WHERE X.FLD_ID = A.FLD_PARENT_ID) AS FLD_PARENT_ID_TXT
			,FLD_ORDINAL
			,FLD_BIZ_KEY
			,FLD_DESC
			, FLD_ID AS id
			, CASE WHEN FLD_PARENT_ID =  0 THEN <![CDATA['##']]> ELSE convert(varchar(255), FLD_PARENT_ID) END AS parent
			, FLD_NM AS text
			 <!-- , cast(FLD_ID as varchar)  +':' +  FLD_NM AS text  -->
		FROM $TABLE_NAME$ A
		ORDER BY FLD_LVL, FLD_ORDINAL
	</select>
	<!-- 하위항목 건수   -->
	<select id="selectChildCount" parameterClass="java.util.Map" resultClass="int">
		SELECT COUNT(1) 
		  FROM $TABLE_NAME$
		 WHERE FLD_PARENT_ID = #FLD_ID#
	</select>
	
	<!-- 관련데이터 건수 -->
	<select id="selectMstrCount" parameterClass="java.util.Map" resultClass="int">
		SELECT COUNT(1) 
		  FROM $MSTR_TABLE_NAME$
		 WHERE FLD_ID = #FLD_ID#
		 <!-- <isNotEqual property="MSTR_TABLE_NAME" compareValue="WP2_ITEM_MSTR">
		 AND DEL_YN = 'N'
		 </isNotEqual>
		 <isNotEqual property="MSTR_TABLE_NAME" compareValue="WP2_ABTEST_MSTR">
		 AND DEL_YN = 'N'
		 </isNotEqual> -->
	</select>
	
	<insert id="insert" parameterClass="java.util.Map">
		/* AdvisorTypeDefDAO.insert */
		INSERT INTO $TABLE_NAME$
           (FLD_NM
           ,FLD_LVL
           ,FLD_PARENT_ID
           ,FLD_ORDINAL
           ,FLD_BIZ_KEY
           <!-- ,FLD_DESC -->
           )
     VALUES
           (#FLD_NM#
           ,ISNULL((select max(FLD_LVL) + 1 as FLD_LVL from $TABLE_NAME$ WHERE FLD_ID = #FLD_PARENT_ID#), 0)
           ,isnull(#FLD_PARENT_ID#,0)
           ,ISNULL((select max(FLD_ORDINAL) + 1 as FLD_ORDINAL from $TABLE_NAME$ WHERE FLD_PARENT_ID = #FLD_PARENT_ID#), 1)
           ,#FLD_BIZ_KEY#
           <!-- ,#FLD_DESC# -->
           )
        <selectKey keyProperty="FLD_ID" resultClass="int">
	        select max(FLD_ID) as FLD_ID from $TABLE_NAME$
	    </selectKey>
	</insert>
	
	<update id="updatePos" parameterClass="java.util.Map">
		<![CDATA[
		UPDATE $TABLE_NAME$
           SET FLD_LVL = ISNULL((select max(FLD_LVL) + 1 as FLD_LVL from $TABLE_NAME$ WHERE FLD_ID = #FLD_PARENT_ID#), 0) 
             , FLD_PARENT_ID = #FLD_PARENT_ID#
             , FLD_ORDINAL = #FLD_ORDINAL#
     	 WHERE FLD_ID = #FLD_ID#
		]]>
	</update>
	
	<update id="updateName" parameterClass="java.util.Map">
		<![CDATA[
		UPDATE $TABLE_NAME$
           SET FLD_NM = #FLD_NM#
     	 WHERE FLD_ID = #FLD_ID#
		]]>
	</update>
	
	<delete id="delete" parameterClass="java.util.Map">
		<![CDATA[
		DELETE 
		  FROM $TABLE_NAME$
     	 WHERE FLD_ID = #FLD_ID#
		]]>
	</delete>
	
	<!-- 위치변경시 기존 순위 데이터 -->
	<!-- 정렬순서 증가일때  뒷순위 앞으로 -->
	<!-- 정렬순서 감소일때  앞순위 뒤로 -->
	<update id="updateSrtOrdEx" parameterClass="java.util.Map">
		<!-- UPDATE A
		   SET A.FLD_ORDINAL = A.FLD_ORDINAL + B.RN
		  FROM $TABLE_NAME$ A
		 INNER JOIN (
					SELECT A.FLD_ID
					, ROW_NUMBER() OVER (ORDER BY FLD_ORDINAL, FLD_ID) AS RN 
					  FROM $TABLE_NAME$ A
					  WHERE FLD_PARENT_ID = #FLD_PARENT_ID#
						AND FLD_ORDINAL >= #FLD_ORDINAL#
					) B
		    ON A.FLD_ID = B.FLD_ID -->
		  
		UPDATE $TABLE_NAME$
		    SET FLD_ORDINAL = FLD_ORDINAL  + (case when #FLD_ORDINAL# <![CDATA[>]]> #OLD_FLD_ORDINAL# then -1 else 1 end)
		  WHERE FLD_PARENT_ID = #FLD_PARENT_ID#
		    AND ((#FLD_ORDINAL#/*NEW*/ <![CDATA[>]]> #OLD_FLD_ORDINAL#/*OLD*/ AND FLD_ORDINAL <![CDATA[>]]> #OLD_FLD_ORDINAL#/*OLD*/ AND FLD_ORDINAL <![CDATA[<=]]> #FLD_ORDINAL#/*NEW*/) 
			OR   (#FLD_ORDINAL#/*NEW*/ <![CDATA[<]]> #OLD_FLD_ORDINAL#/*OLD*/ AND FLD_ORDINAL <![CDATA[>=]]> #FLD_ORDINAL#/*NEW*/ AND FLD_ORDINAL <![CDATA[<]]> #OLD_FLD_ORDINAL#/*OLD*/))
	</update>
    
    <!--정렬순위 수정 -->
	<update id="updateSrtOrdAll" parameterClass="java.util.Map">
		UPDATE A
		   SET A.FLD_ORDINAL = B.RN
		  FROM $TABLE_NAME$ A
		 INNER JOIN (
					SELECT A.FLD_ID
					, ROW_NUMBER() OVER (ORDER BY FLD_ORDINAL, FLD_ID) AS RN 
					  FROM $TABLE_NAME$ A
					  WHERE FLD_PARENT_ID = #FLD_PARENT_ID#
					) B
		    ON A.FLD_ID = B.FLD_ID
	</update>

</sqlMap>