<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="CommDAO">
    <resultMap class="java.util.HashMap" id="selectGetMenuList">
    <result column = "MENU_LEVEL" property="MENU_LEVEL"/>
    <result column = "MENU_SORT" property="MENU_SORT"/>
    <result column = "UPPER_MENU_NO" property="UPPER_MENU_NO"/>
    <result column = "MENU_NO" property="MENU_NO"/>
    <result column = "MENU_NM" property="title"/>
    <result column = "MENU_DESC" property="MENU_DESC"/>
    <result column = "PROGRM_URL" property="url"/>
    </resultMap>

	<!-- 공통 로그를 저장한다. -->
	<insert id="insertCommonLog" parameterClass="java.util.Map">
	    /* CommDAO.insertCommonLog */	
		INSERT INTO SYS_ACCHIST (
            PROG_URL,
			USER_ID,
			ACCHIST_YYYY,
			ACCHIST_MM,
			ACCHIST_DD,
			ACCHIST_DTTM,
			IP_ADDR,
            SERVER_NM
		) VALUES (
			#progNm#,
			#userId#,
			DATE_FORMAT(NOW(), '%Y'),
			DATE_FORMAT(NOW(), '%m'),
			DATE_FORMAT(NOW(), '%d'),
			NOW() ,
			#userIp#,
            #serverNm#
		)
	</insert>
	
	<select id="selectCodeList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		/* CommDAO.selectCodeList */
		SELECT CATG_CD
		      ,DTL_CD
		      ,DTL_CD_NM
		      ,DTL_CD_DESC
		      ,DTL_CD_ORD
		      ,DEL_YN
		  FROM TB_DTL_CD
		  WHERE CATG_CD = #CATG_CD#
		  <isNotEmpty property="DEL_YN">
		  AND DEL_YN = #DEL_YN#
		  </isNotEmpty>
		  ORDER BY DTL_CD_ORD
	</select>
	
	<select id="getSeq" parameterClass="java.util.Map" resultClass="java.lang.String">
		/* CommDAO.getSeq */
		SELECT 	F_GET_SEQ(#SEQ_NM#) SEQ
	</select>
	
	<select id="selectTest" resultClass="java.lang.String">
		/* UserDAO.selectTest */
		SELECT 1 AS testData
	</select>

	<select id="CommDAO.selectGetMenuList" parameterClass="java.util.HashMap"  resultMap="selectGetMenuList">
	/*메뉴리스트*/
   SELECT 
  		MENU_LEVEL
  		,MENU_SORT
  		,UPPER_MENU_NO
  		,MENU_NO
  		,MENU_NM
  		,PROGRM_URL
  		,MENU_DESC
	FROM TB_MENU M
	WHERE 1=1
	AND MENU_LEVEL =  #LV#	
	AND DEL_YN = 'N'
	AND USE_YN = 'Y'
    AND EXISTS
    (
    
          SELECT 1 
          FROM TB_AUTH_GROUP_USER_RLTN GU_R INNER JOIN TB_AUTH_GROUP_MENU_RLTN GM_R
          ON GU_R.AUTH_GROUP_NO = GM_R.AUTH_GROUP_NO
          INNER JOIN TB_AUTH_GROUP AUTH
          ON AUTH.AUTH_GROUP_NO = GM_R.AUTH_GROUP_NO
          WHERE USER_ID = #userId#
          AND GU_R.DEL_YN = 'N'
          AND GM_R.DEL_YN = 'N'
          AND AUTH.DEL_YN = 'N'
          AND GM_R.MENU_NO = M.MENU_NO
    
    )
	ORDER BY MENU_LEVEL,UPPER_MENU_NO,MENU_SORT
	</select>
	
	
	<select id="CommDAO.selectGetMenuCurrent" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
	/*서브페이지 네비게이션*/
		SELECT 
		    LV1.MENU_NM AS MENU_NM_LV1
		    ,LV2.MENU_NM AS MENU_NM_LV2
		    ,LV3.MENU_NM AS MENU_NM_LV3
		    
		    ,LV2.UPPER_MENU_NO AS UPPER_MENU_NO_LV2
		    ,LV3.UPPER_MENU_NO AS UPPER_MENU_NO_LV3
		    
		    ,IFNULL(IFNULL(LV3.PROGRM_URL,LV2.PROGRM_URL),LV1.PROGRM_URL) AS PROGRM_URL
		FROM (
		      (SELECT MENU_NO,UPPER_MENU_NO,MENU_NM,PROGRM_URL FROM TB_MENU
		      WHERE USE_YN = 'Y'
		      AND DEL_YN = 'N'
		      AND MENU_LEVEL = 1) LV1
		      LEFT JOIN 
		      (SELECT MENU_NO,UPPER_MENU_NO,MENU_NM,PROGRM_URL FROM TB_MENU
		      WHERE USE_YN = 'Y'
		      AND DEL_YN = 'N'
		      AND MENU_LEVEL = 2) LV2
		      ON LV1.MENU_NO = LV2.UPPER_MENU_NO
		      ) LEFT JOIN 
		      (SELECT MENU_NO,UPPER_MENU_NO,MENU_NM,PROGRM_URL FROM TB_MENU
		      WHERE USE_YN = 'Y'
		      AND DEL_YN = 'N'
		      AND MENU_LEVEL = 3) LV3
		 ON LV2.MENU_NO = LV3.UPPER_MENU_NO
		 WHERE  IFNULL(IFNULL(LV3.MENU_NO,LV2.MENU_NO),LV1.MENU_NO) = #MENU_NO#
	</select>
	
	<!-- 세그먼트분석 데이터항목 리스트 -->
	<select id="CommDAO.selectClustVarList" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
	SELECT DISTINCT col.name
		, #IU_TYPE# AS IU_TYPE
		,col.colorder
	FROM sysobjects obj, syscolumns col
	WHERE obj.id = col.id
	AND obj.name = #TABLE_NAME#
	ORDER BY colorder
	</select>
	<select id="CommDAO.selectListBySql" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
	$sql$
	</select>



	<select id="selectUserLogin" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		/* CommDAO.selectUserLogin */
		<![CDATA[

	 	
	 	SELECT 
	 	     CMPN_CD
			, BSTOR_CD
			, MBR_NO
			, EMAIL_ADR
			, PWD PASSWD
			, TEL_NO
			, JOIN_DTM
			, MBR_MST_YN
			, DEL_YN
			, UPD_DTM
			, LOAD_DTM
			, ERR_CNT
		FROM   aiblue_ocr.TB_MBR_MST MEM
		WHERE 1=1
		AND SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#

		]]>
	</select>


	<select id="selectUserLoginInfo" parameterClass="java.lang.String" resultClass="java.util.HashMap">
		/* CommDAO.selectUserLoginInfo */
		<![CDATA[

	 	
	 	SELECT 
	 	     CMPN_CD
			, BSTOR_CD
			, MBR_NO
			, EMAIL_ADR
			, TEL_NO
			, JOIN_DTM
			, MBR_MST_YN
			, DEL_YN
			, UPD_DTM
			, LOAD_DTM
			, ERR_CNT
			, USER_ID
		FROM   aiblue_ocr.TB_MBR_MST MEM
		WHERE 1=1
		AND USER_ID = #userId#
		AND DEL_YN = 'N'

		]]>
	</select>
	
	<select id="selectUserLoginErrCnt" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		/* CommDAO.selectUserLoginErrCnt */
		<![CDATA[

	 	
	 	SELECT 
               ERR_CNT
		FROM   aiblue_ocr.TB_MBR_MST MEM
		WHERE 1=1
		AND SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#

		]]>
	</select>
	
	

	 
			
	<!-- 공통 로그를 저장한다. -->
	<insert id="loginLog" parameterClass="java.util.HashMap">
	    /* CommDAO.loginLog */	
	        		<![CDATA[
	   	 INSERT INTO aiblue_ocr.TB_SESSN_ADM 
		             (LOG_DTM, MBR_NO, IP, EXP_YN)
		 VALUES(NOW()
		 , (select max(MBR_NO) from aiblue_ocr.TB_MBR_MST
		 where 1=1
		 AND SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#)
		 , #IP#
		 , 'N')
		     	]]>
	</insert>
	<!-- 공통 로그를 저장한다. -->
	<insert id="insertSuccessLoginLog" parameterClass="java.lang.String">
	    /* CommDAO.insertSuccessLoginLog */	
		UPDATE 	aiblue_ocr.TB_MBR_MST  
		SET 	UPD_DTM = NOW(), 
				ERR_CNT = 0 
		WHERE 	1=1
		AND SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#
	</insert>
	
	<!-- 공통 로그를 저장한다. -->
	<insert id="insertSuccessLoginLogDetail" parameterClass="java.util.HashMap">
	    /* CommDAO.insertSuccessLoginLogDetail */	
	INSERT INTO aiblue_ocr.LOG_SYS_TXN (LOG_DTM, STEP_NM, PID, JOB_NM, ARG_VAL, LOG_MSG, ST_END_DIV, CMPLT_MSG)
	 VALUES(
	 NOW()
	 , 'LOGIN'
	 ,  #PID#
	 , 'LOGIN_ATTEMP'
	 , CONCAT('ID : ',(CASE
		WHEN IFNULL(INSTR(#userId#, '@'), 0) > 0 THEN IFNULL(SUBSTRING(#userId#, 0, INSTR(#userId#, '@')),'')
		ELSE #userId#
	END),' , IP : ',#IP#)
	 , '성공'
	 ,''
	 ,''
	 )
	</insert>
	
	<!-- 공통 로그를 저장한다. -->
	<insert id="insertFailLoginLog" parameterClass="java.lang.String">
	    /* CommDAO.insertFailLoginLog */	
		UPDATE 	aiblue_ocr.TB_MBR_MST  
		SET 	UPD_DTM = NOW(), 
				ERR_CNT = ERR_CNT +1 
		WHERE 	1=1
		AND SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#
	</insert>
	
	
	<!-- 공통 로그를 저장한다. -->
	<insert id="insertFailLoginLogDetail" parameterClass="java.util.HashMap">
	    /* CommDAO.insertFailLoginLogDetail */	
	INSERT
		INTO
		aiblue_ocr.LOG_SYS_TXN (LOG_DTM,
		STEP_NM,
		PID,
		JOB_NM,
		ARG_VAL,
		LOG_MSG,
		ST_END_DIV,
		CMPLT_MSG)
	VALUES( NOW() ,
	'LOGIN' ,
	#PID# ,
	'LOGIN_ATTEMP' ,
	CONCAT('ID : ',(CASE
		WHEN IFNULL(INSTR(#userId#, '@'), 0) > 0 THEN IFNULL(SUBSTRING(#userId#, 0, INSTR(#userId#, '@')),'')
		ELSE #userId#
	END),' , IP : ',#IP#) ,
	CONCAT('실패 로그인 ',IFNULL(CAST((SELECT MAX(ERR_CNT) FROM aiblue_ocr.TB_MBR_MST WHERE SUBSTRING(EMAIL_ADR, 0, INSTR(EMAIL_ADR, '@')) = #userId#) AS CHAR(50)),'0'),'회 시도') ,
	'' ,
	'' )
	</insert>
	

 	<select id="selectAutoUserLogin" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		/* CommDAO.selectAutoUserLogin */
		<![CDATA[

	 	
	     SELECT MAX(USERID) USERID FROM (
		  SELECT (select MAX((CASE WHEN INSTR(EMAIL_ADR, '@') > 0 THEN SUBSTRING_INDEX(EMAIL_ADR, '@', 1) ELSE EMAIL_ADR END)) 
		          from aiblue_ocr.TB_MBR_MST x where x.MBR_NO = a.MBR_NO) USERID
			FROM aiblue_ocr.TB_SESSN_ADM a
			WHERE 1=1 
			AND IP = #IP# 
			AND EXP_YN = 'N'
			AND DATEDIFF(N,LOG_DTM,NOW())< 10 
	     UNION ALL 
		 SELECT ''
		 ) A

		]]>
	</select>


	<!-- 공통 로그를 저장한다. -->
	<insert id="logout" parameterClass="java.util.HashMap">
	    /* CommDAO.logout */	
	    		<![CDATA[
   	 INSERT INTO aiblue_ocr.TB_SESSN_ADM 
	             (LOG_DTM, MBR_NO, IP, EXP_YN)
	 VALUES(NOW(), 
		  (select max(MBR_NO) from aiblue_ocr.TB_MBR_MST
		 where 1=1
		 AND SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#)
    , #IP#, 'Y')
    	]]>
	</insert>

       
	<select id="autologoinChk" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		/* CommDAO.autologoinChk */
		<![CDATA[

	 	
				 SELECT ISNULL(MAX(EXP_YN),'Y') EXP_YN FROM aiblue_ocr.TB_SESSN_ADM TT
				 WHERE EXISTS 
				
				 (
				 SELECT 1 FROM (
						 select max(LOG_DTM) LOG_DTM,MBR_NO from aiblue_ocr.TB_SESSN_ADM t
						 where exists 
						 (select 1 from (
						         select max(MBR_NO) MBR_NO
								 from aiblue_ocr.TB_MBR_MST
						 		 where  SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#
								 AND IP = #IP#
								 ) s where t.MBR_NO = s.MBR_NO
						 )
						 AND DATEDIFF(N,LOG_DTM,NOW())< 10 
						 group by MBR_NO
					) SS WHERE TT.LOG_DTM = SS.LOG_DTM 
					     AND TT.MBR_NO = SS.MBR_NO
				)

 


		]]>
	</select>
	
	<select id="logChk" parameterClass="java.util.HashMap" resultClass="java.util.HashMap">
		/* CommDAO.logChk */
		<![CDATA[
		
		SELECT TOP 1 EXP_YN 
  		FROM aiblue_ocr.TB_SESSN_ADM 
  		WHERE IP = #IP#
  		AND MBR_NO = (SELECT MBR_NO FROM aiblue_ocr.TB_MBR_MST WHERE SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#) 
  		AND EXP_YN = 'N'
  		AND DATEDIFF(N,LOG_DTM,NOW()) < 10

		]]>
	</select>
	<update id="logupd" parameterClass="java.util.HashMap">
		  /* CommDAO.logupd */	
	    		<![CDATA[
   	 UPDATE aiblue_ocr.TB_SESSN_ADM 
	    SET LOG_DTM = NOW()
	    WHERE 1=1
		AND MBR_NO = (SELECT MBR_NO FROM aiblue_ocr.TB_MBR_MST WHERE SUBSTRING_INDEX(EMAIL_ADR, '@', 1) = #userId#) 
  		AND EXP_YN = 'N'
  		AND IP = #IP#
  		AND DATEDIFF(N,LOG_DTM,NOW()) < 10
    	]]>
	</update>
</sqlMap> 
