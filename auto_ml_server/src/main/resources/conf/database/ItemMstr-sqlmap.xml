<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN" "http://ibatis.apache.org/dtd/sql-map-2.dtd">

<sqlMap namespace="ItemMstrDAO">

	<select id="selectListForItemTree" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* ItemMstrDAO.selectListForItemTree */
		SELECT
			id
			, text
			, children
			, type
			, ord1
			, ord2
			, FLD_ID
			, FLD_NM
			, ITEM_ID
			, ITEM_NM
		FROM (
			SELECT
				'T' + CAST(FLD_ID AS CHAR(50)) AS id
				, FLD_NM AS text
				, CONVERT(
					BIT
					, (SELECT COUNT(*) FROM WP2_TYPE_ITEM_MSTR WHERE FLD_PARENT_ID = A.FLD_ID)
						+ (SELECT COUNT(*) FROM WP2_ITEM_MSTR WHERE FLD_ID = A.FLD_ID AND USE_YN = 'Y')
					) AS children
				, 'typeItem' AS type
				, 1 AS ord1
				, FLD_ORDINAL as ord2
				, FLD_ID AS FLD_ID
				, FLD_NM AS FLD_NM
				, NULL AS ITEM_ID
				, NULL AS ITEM_NM
			FROM WP2_TYPE_ITEM_MSTR A
			WHERE FLD_PARENT_ID = #FLD_PARENT_ID#
			UNION ALL
			SELECT
				CAST(B.ITEM_ID AS CHAR(50)) AS id
				, B.ITEM_NM AS text
				, CONVERT(BIT, 0) AS children
				, 'item' AS type
				, 2 AS ord1
				, B.ORDINAL as ord2
				, B.FLD_ID AS FLD_ID
				, C.FLD_NM AS FLD_NM
				, B.ITEM_ID AS ITEM_ID
				, B.ITEM_NM AS ITEM_NM
			FROM WP2_ITEM_MSTR B
	  			JOIN WP2_TYPE_ITEM_MSTR C ON B.FLD_ID = C.FLD_ID
			WHERE B.FLD_ID = #FLD_PARENT_ID#
				AND B.USE_YN = 'Y'
				<isNotEmpty prepend="AND" property="exceptItemId">
					<iterate prepend="B.ITEM_ID NOT IN " property="exceptItemId" open="(" close=")" conjunction=",">
						$exceptItemId[]$
					</iterate>
				</isNotEmpty>
		) AS C
		ORDER BY ord1, ord2
	</select>

	<!--select id="selectListForItemGrid" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		/* ItemMstrDAO.selectListForItemGrid */
		SELECT
			A.SEG_ID
			,A.STATS_ID
			,A.STATS_NM
			,A.FLD_ID
			,A.RTN_CNT
			,A.STATS_TYPE
			,A.IU_TYPE
			,A.DESIGN_KEY_VALUE
			,A.STATS_DESC
			,A.DEL_YN
			,A.ORDINAL
			,A.STATS_STATUS
			,A.REG_USER_NO
			,A.REG_DT
			,A.UPD_USER_NO
			,A.UPD_DT
			,B.FLD_NM
			,C.SEG_NM
			,D.CODE_NM AS STATS_TYPE_NM
			,E.CODE_NM AS STATS_STATUS_NM
			,dbo.F_CODE_NM('SEG_STATUS', A.STATS_STATUS) AS STATS_STATUS_NM
			,dbo.F_CODE_NM('IU_TYPE', A.IU_TYPE) AS IU_TYPE_NM
			,dbo.F_DECRYPT(A.STATS_XML) AS STATS_XML
			,dbo.F_DECRYPT(A.STATS_SQL) AS STATS_SQL
  		FROM WP2_STATS_MSTR A
  			JOIN WP2_TYPE_STATS_MSTR B ON A.FLD_ID = B.FLD_ID
  			JOIN WP2_SEG_MSTR C ON A.SEG_ID = C.SEG_ID
  			JOIN WP2_CODE_MSTR D ON D.PARENT_ID = 'STATS_TYPE' AND D.CODE_ID = A.STATS_TYPE
  			JOIN WP2_CODE_MSTR E ON E.PARENT_ID = 'SEG_STATUS' AND E.CODE_ID = A.STATS_STATUS
  		WHERE 1=1
			AND A.FLD_ID = #FLD_ID#
			AND A.DEL_YN = 'N' 
		ORDER BY A.ORDINAL
	</select-->
	
	<!-- 수정 -->
	<!--update id="update" parameterClass="java.util.HashMap">
		UPDATE
			WP2_STATS_MSTR
		SET
			SEG_ID = #SEG_ID#
			,STATS_NM = #STATS_NM#
			,FLD_ID = #FLD_ID#
			,RTN_CNT = #RTN_CNT#
			,STATS_TYPE = #STATS_TYPE#
			,IU_TYPE = #IU_TYPE#
			,DESIGN_KEY_VALUE = #DESIGN_KEY_VALUE#
			,STATS_XML = dbo.F_ENCRYPT(#STATS_XML#)
			,STATS_SQL = dbo.F_ENCRYPT(#STATS_SQL#)
			,STATS_DESC = #STATS_DESC#
			,ORDINAL = #ORDINAL#
			,STATS_STATUS = #STATS_STATUS#
			,UPD_USER_NO = #USER_NO#
			,UPD_DT = NOW()
		WHERE
			STATS_ID = #STATS_ID#
	</update-->
	
	<!-- 삭제 -->
	<!--update id="delete" parameterClass="java.util.HashMap">
		UPDATE
			WP2_STATS_MSTR
		SET
			DEL_YN = 'Y'
			,UPD_USER_NO = #USER_NO#
			,UPD_DT = NOW()
		WHERE
			STATS_ID = #STATS_ID#
	</update-->
	
	<!--insert id="insert" parameterClass="java.util.Map">
		INSERT INTO WP2_STATS_MSTR (
			SEG_ID
			,STATS_NM
			,FLD_ID
			,RTN_CNT
			,STATS_TYPE
			,IU_TYPE
			,DESIGN_KEY_VALUE
			,STATS_XML
			,STATS_SQL
			,STATS_DESC
			,DEL_YN
			,ORDINAL
			,STATS_STATUS
			,REG_USER_NO
			,REG_DT
		) VALUES (
			#SEG_ID#
			,#STATS_NM#
			,#FLD_ID#
			,#RTN_CNT#
			,#STATS_TYPE#
			,#IU_TYPE#
			,#DESIGN_KEY_VALUE#
			,dbo.F_ENCRYPT(#STATS_XML#)
			,dbo.F_ENCRYPT(#STATS_SQL#)
			,#STATS_DESC#
			,#DEL_YN#
			,#ORDINAL#
			,#STATS_STATUS#
			,#USER_NO#
			,NOW()
		)
		<selectKey keyProperty="STATS_ID" resultClass="Integer">
			SELECT ident_current('WP2_STATS_MSTR')
		</selectKey>
	</insert>

 	<select id="selectListByItemNm" parameterClass="java.util.Map" resultClass="java.util.HashMap">
		SELECT
			A.SEG_ID
			,A.STATS_ID
			,A.STATS_NM
			,A.FLD_ID
			,A.RTN_CNT
			,A.STATS_TYPE
			,A.IU_TYPE
			,A.DESIGN_KEY_VALUE
			,A.STATS_DESC
			,A.DEL_YN
			,A.ORDINAL
			,A.STATS_STATUS
			,A.REG_USER_NO
			,A.REG_DT
			,A.UPD_USER_NO
			,A.UPD_DT
			,B.FLD_NM
			,C.SEG_NM
			,D.CODE_NM AS STATS_TYPE_NM
			,E.CODE_NM AS STATS_STATUS_NM
  		FROM WP2_STATS_MSTR A
  			JOIN WP2_TYPE_STATS_MSTR B ON A.FLD_ID = B.FLD_ID
  			JOIN WP2_SEG_MSTR C ON A.SEG_ID = C.SEG_ID
  			JOIN WP2_CODE_MSTR D ON D.PARENT_ID = 'STATS_TYPE' AND D.CODE_ID = A.STATS_TYPE
  			JOIN WP2_CODE_MSTR E ON E.PARENT_ID = 'SEG_STATUS' AND E.CODE_ID = A.STATS_STATUS
  		WHERE 1=1
		  AND A.STATS_NM = #STATS_NM#
		  AND A.DEL_YN = 'N'
	</select-->

</sqlMap>